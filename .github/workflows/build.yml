name: Run build on push
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
  schedule:
    - cron: "0 7 * * 1,3,5"
  workflow_dispatch:
env:
  VBUILD_UNIT_TESTS: false
  CONAN_VER: 1.52.0
jobs:
  run-build-mac:
    runs-on: macos-11

    strategy:
      matrix:
        python-version: [ '3.8', '3.9', '3.10' ]

    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Check out repository code
        uses: actions/checkout@v2
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
            python-version: ${{ matrix.python-version }}

      - name: Install Conan
        run: pip3 install conan==${{ env.CONAN_VER }} --force

      - name: Run build
        run: |
          cd ${{ github.workspace }}
          ./build-all.sh

      - name: Upload wheels
        uses: actions/upload-artifact@v2
        with:
          path: src/python-bindings/pips/dist/*.whl

      - run: echo "üçè This job's status is ${{ job.status }}."

  run-build-windows:
    runs-on: windows-2019
    env:
      VBUILDRELEASE: Release
      VBUILDDEBUG: Debug
      VBUILDMODE: Release

    strategy:
      matrix:
        python-version: [ '3.8', '3.9', '3.10' ]

    steps:
      - run: echo "üéâ The job was automatically triggered by a %github.event_name% event."
      - run: echo "üêß This job is now running on a %runner.os% server hosted by GitHub!"
      - run: echo "üîé The name of your branch is %github.ref% and your repository is %github.repository%."

      - name: Check out repository code
        uses: actions/checkout@v2
      - run: echo "üí° The %github.repository% repository has been cloned to the runner."

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Conan
        run: pip3 install conan==${{ env.CONAN_VER }} --force

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Run build
        run: |
          cd ${{ github.workspace }}
          .\build-all.bat

      - name: Upload wheels
        uses: actions/upload-artifact@v2
        with:
          path: src/python-bindings/pips/dist/*.whl

  run-build-manylinux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build
        run: ./docker/manylinux/deploy.sh

      - name: Upload wheels
        uses: actions/upload-artifact@v2
        with:
          path: src/python-bindings/pips/dist/*.whl

  run-build-manylinux-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: all
          
      - name: Build
        run: ./docker/manylinux_aarch64/deploy.sh

      - name: Upload wheels
        uses: actions/upload-artifact@v2
        with:
          path: src/python-bindings/pips/dist/*.whl
